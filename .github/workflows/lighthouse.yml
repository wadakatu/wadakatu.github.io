name: Lighthouse CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://www.wadakatu.dev/
            https://www.wadakatu.dev/about/
            https://www.wadakatu.dev/blog/
            https://www.wadakatu.dev/projects/
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Comment on PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const manifest = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};

            const formatScore = (score) => {
              if (score === null) return 'N/A';
              const percent = Math.round(score * 100);
              if (percent >= 90) return `ðŸŸ¢ ${percent}`;
              if (percent >= 50) return `ðŸŸ  ${percent}`;
              return `ðŸ”´ ${percent}`;
            };

            let comment = '## âš¡ Lighthouse Results\n\n';
            comment += '| URL | Performance | Accessibility | Best Practices | SEO |\n';
            comment += '|-----|-------------|---------------|----------------|-----|\n';

            const urlResults = {};
            for (const result of manifest) {
              const url = new URL(result.url).pathname || '/';
              if (!urlResults[url]) {
                urlResults[url] = result;
              }
            }

            for (const [url, result] of Object.entries(urlResults)) {
              const perf = formatScore(result.summary.performance);
              const a11y = formatScore(result.summary.accessibility);
              const bp = formatScore(result.summary['best-practices']);
              const seo = formatScore(result.summary.seo);
              comment += `| \`${url}\` | ${perf} | ${a11y} | ${bp} | ${seo} |\n`;
            }

            comment += '\n<details><summary>ðŸ“Š View Full Reports</summary>\n\n';
            for (const [url, link] of Object.entries(links)) {
              const path = new URL(url).pathname || '/';
              comment += `- [\`${path}\`](${link})\n`;
            }
            comment += '\n</details>';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('âš¡ Lighthouse Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }
