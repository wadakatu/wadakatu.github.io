---
title: "Next.jsåˆå¿ƒè€…ãŒLogã‚’å‡ºã™ã¾ã§ã«è‹¦åŠ´ã—ãŸè©±"
emoji: "ğŸ™‡â€â™‚ï¸"
type: "tech"
topics:
  - "next"
  - "typescript"
  - "ecs"
  - "logger"
  - "pino"
published: true
published_at: "2023-08-18 15:52"
---

# ä½•ãŒã—ãŸã‹ã£ãŸã®ã‹

[pinojs/pino](https://github.com/pinojs/pino)ã‚’ä½¿ã£ã¦ã€Next.jsã®APIã‚’å©ã„ãŸæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ­ã‚°ã‚’ã€CloudWatch Logsã§ç¢ºèªã—ãŸã„ã€‚

# å‰ææ¡ä»¶

- ç­†è€…ã¯ã€Next.jsåˆå¿ƒè€…ï¼ˆé–“é•ã£ã¦ã„ã‚‹ã“ã¨ã¯æŒ‡æ‘˜ãŠé¡˜ã„ã—ã¾ã™ï¼ï¼‰
- pinoã¯ `yarn add pino`ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆ
	- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ã€å•é¡Œãªããƒ­ã‚°ã¯å‡ºã¦ã„ã‚‹
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€AWS ECS Fargateã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
	- ECSã®ã‚¿ã‚¹ã‚¯å®šç¾©ã«ã¦[awslogs](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_awslogs.html)ã®è¨­å®šã¯å®Ÿæ–½æ¸ˆã¿
	- CloudWatch Logsã®ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚ä½œæˆæ¸ˆ

## å®Ÿè£…

### ãƒ­ã‚¬ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

```js:/lib/logger.ts
import { pino } from 'pino';

export const logger = pino({
  level: process.env.NODE_ENV !== 'production' ? 'debug' : 'info',
});
```

### APIã€€(url: /api/health-check)

```js:/src/app/api/health-check/route.ts
import { NextResponse } from 'next/server';
import { logger } from '@/lib/logger';

export function GET() {
  logger.info('info');
  logger.warn('warn');
  logger.error('error');
  logger.fatal('fatal');
  return NextResponse.json({ message: 'ok' });
}
```

ã—ã‹ã—ã€ä¸Šè¨˜ã®APIã‚’ã„ãã‚‰å©ã„ã¦ã‚‚ãƒ­ã‚°ãŒå‡ºã¦ã“ãªã„....

# åŸå› 

ãƒ­ã‚°ã‚’ä»•è¾¼ã‚“ã APIãŒã€`next build`ã‚’å®Ÿè¡Œã—ãŸæ™‚ã«é™çš„ãªHTMLã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãŸã€‚

```bash
Route (app)                                Size     First Load JS
â”Œ â—‹ /                                      82.5 kB         161 kB
â””  â—‹ /api/health-check                      0 B                0 B
Route (pages)                              Size     First Load JS
â”€ â—‹ /404                                   182 B          76.5 kB
+ First Load JS shared by all              76.3 kB
  â”œ chunks/framework-3d1e9be70c3da.js   45.1 kB
  â”œ chunks/main-f4d50592e90a51.js        29.4 kB
  â”œ chunks/pages/_app-529524f99094ab.js  195 B
  â”” chunks/webpack-9eacbfc3ea00.js     1.67 kB

Î»  (Server)  server-side renders at runtime (uses getInitialProps or getServerSideProps)
â—‹  (Static)  automatically rendered as static HTML (uses no initial props)
```

---

**ã“ã®éƒ¨åˆ†ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚**

```bash
â””  â—‹ /api/health-check                      0 B                0 B

â—‹  (Static)  automatically rendered as static HTML (uses no initial props)
```

`/api/health-check`ã®å·¦ã«ã€Œâšªï¸ã€ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯ã€ã“ã®APIãŒãƒ“ãƒ«ãƒ‰æ™‚ã«è‡ªå‹•çš„ã«é™çš„HTMLã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

---

Next.jsã§ã¯ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«å„ãƒ•ã‚¡ã‚¤ãƒ«ã« `getServerSideProps`ã€€or `getInitialProps`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
- å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
	- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«ã¦ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹åº¦ã«HTMLã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ï¼ˆServer-side Rendering)
	- JSãƒ•ã‚¡ã‚¤ãƒ«ã®ã¾ã¾ãªã®ã§ã€`logger.info()`ãŒå®Ÿè¡Œã•ã‚Œã¦ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- å«ã¾ã‚Œã¦ã„ãªã„å ´åˆ
	- äº‹å‰ã«é™çš„HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹åº¦ã«ãã®HTMLã‚’è¿”ã—ã¾ã™
	- HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯JSã¯å‹•ã‹ãªã„ã®ã§ã€`logger.info()`ã¯å®Ÿè¡Œã•ã‚Œãšã€ãƒ­ã‚°ã‚‚å‡ºãªã„

https://nextjs.org/docs/pages/building-your-application/rendering/automatic-static-optimization

https://zenn.dev/unreact/articles/nextjs-advanced-automatic-static-optimization-jp

# è§£æ±ºç­–

è§£æ±ºç­–ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚
Server-side Renderingã®APIã«ãƒ­ã‚°ã‚’ä»•è¾¼ã‚ã°OKã§ã—ãŸã€‚

ä»Šå›ã¯ã€æ¤œè¨¼ã®ãŸã‚`api/health-check`ã«`getServerSideProps`ã‚’ä»•è¾¼ã‚“ã§ã€ç„¡ç†ã‚„ã‚ŠServer-side Renderingã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
```bash
â”œ Î» /api/health-check  

Î»  (Server)  server-side renders at runtime (uses getInitialProps or getServerSideProps)
```

ä¸Šè¨˜ã®çŠ¶æ…‹ã§ã€APIã‚’å©ã„ã¦ã¿ã‚‹ã¨ã€ç„¡äº‹CloudWatch Logsã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸğŸ™ŒğŸ‰

# ã‚ã¨ãŒã

ä»Šå›ã¯ã€`next build`æ™‚ã®æŒ™å‹•ã‚’ã¡ã‚ƒã‚“ã¨ç†è§£ã§ãã¦ã„ãªã‹ã£ãŸã®ãŒæœ€å¤§ã®æ•—å› ã§ã™ã€‚
ãã®ã›ã„ã§ã€`å®Ÿã¯pinoã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚°ãªã‚“ã˜ã‚ƒãªã„ï¼Ÿ` ã¨ã‹ `AWS ECSã®ã‚¿ã‚¹ã‚¯å®šç¾©ã¡ã‚ƒã‚“ã¨ã§ããªã„ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿ`ãªã©ãªã©ã€ è‰²ã€…ãªæ–¹ã€ã‚‚ã®ã«æ¿¡ã‚Œè¡£ã‚’ç€ã›ã¾ãã£ã¦ã¾ã—ãŸã€‚ã€‚
ã—ã‹ã—ã€æ‚ªã„ã®ã¯**ç§ã§ã—ãŸã€‚ã€‚**
ã“ã†ã„ã†å‹•ä½œã™ã‚‹ã¹ãã‚‚ã®ãŒå‹•ä½œã—ãªã„æ™‚ã¯ã€ä»Šã¾ã§ã®çµŒé¨“ä¸Šï¼™ï¼˜ï¼…è‡ªåˆ†ãŒæ‚ªã„ã®ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚ãã‚Œã‚’æ„è­˜ã—ãªãŒã‚‰é–‹ç™ºç¶šã‘ã¦ã„ãã¾ã™ã€‚

ãƒã‚¸ã§ã€CloudWatchã«ãƒ­ã‚°ãŒå‡ºãŸæ™‚ã¯ã€å¬‰ã—ã™ãã¦çµæ§‹å¤§ãã„å£°å‡ºã¾ã—ãŸã€‚ã€‚ã€‚ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã§ã‚ˆã‹ã£ãŸï¼‰