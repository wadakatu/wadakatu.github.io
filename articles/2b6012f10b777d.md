---
title: "Contextual Bindingã®ä»•æ§˜å¤‰æ›´ã«ã¤ã„ã¦ï¼ˆLumen v10 -> v11ï¼‰"
emoji: "ğŸ« "
type: "tech"
topics:
  - "laravel"
  - "php"
  - "lumen"
  - "servicecontainer"
  - "contextualbinding"
published: true
published_at: "2025-04-14 11:26"
publication_name: "studio"
---

## ã¯ã˜ã‚ã«

Lumen v10ã‹ã‚‰v11ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹éš›ã€æ„å›³ã—ãªã„å‹•ä½œã«æˆ¸æƒ‘ã£ãŸæ–¹ã‚‚ã„ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ç§ã¯ã€Contextual Bindingã®ä»•æ§˜å¤‰æ›´ã«ã‚ˆã‚Šã€ä»¥å‰ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã—ãªããªã‚‹ã‚±ãƒ¼ã‚¹ã«é­é‡ã—ã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€Contextual Bindingã«é–¢ã™ã‚‹å¤‰æ›´ç‚¹ã‚’å…·ä½“çš„ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨ä¸€ç·’ã«è§£èª¬ã—ã¾ã™ã€‚v10ã§ã®å‹•ä½œä¾‹ã€v11ã§ç™ºç”Ÿã™ã‚‹å•é¡Œã€ãã—ã¦ãã®è§£æ±ºæ–¹æ³•ã‚’é †ã‚’è¿½ã£ã¦èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

> **å‚è€ƒ:** Contextual Bindingã®åŸºæœ¬ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€[Laravelå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://laravel.com/docs/10.x/container#contextual-binding)ã‚’ã”è¦§ãã ã•ã„ã€‚

---

## ä»•æ§˜å¤‰æ›´ã®èƒŒæ™¯

:::message
**ã€é‡è¦ãªå¤‰æ›´ç‚¹ã€‘**

**Lumen v10**: `when` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ãŸContextual BindingãŒã€DIãƒã‚§ãƒ¼ãƒ³å…¨ä½“ï¼ˆé–“æ¥çš„ãªä¾å­˜é–¢ä¿‚ï¼‰ã«é©ç”¨ã•ã‚Œã‚‹

**Lumen v11**: `when` ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸã‚¯ãƒ©ã‚¹ã«ç›´æ¥DIã•ã‚Œã‚‹å ´åˆã®ã¿é©ç”¨ã•ã‚Œã‚‹
:::

Lumen v10ã§ã¯ã€`when` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ãŸContextual BindingãŒã€DIï¼ˆä¾å­˜æ³¨å…¥ï¼‰ã®ãƒã‚§ãƒ¼ãƒ³ã‚’é£›ã³è¶Šãˆã¦é©ç”¨ã•ã‚Œã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ã¤ã¾ã‚Šã€ã‚ã‚‹ã‚¯ãƒ©ã‚¹ã®ä¾å­˜å…ˆã«è¨­å®šã—ãŸå…·è±¡ã‚¯ãƒ©ã‚¹ãŒã€ãã®å…ˆã®DIã«ã‚‚åæ˜ ã•ã‚Œã¦ã„ãŸã®ã§ã™ã€‚

ã—ã‹ã—ã€v11ã§ã¯ã“ã®æŒ™å‹•ãŒå¤‰æ›´ã•ã‚Œã€`when` ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸã‚¯ãƒ©ã‚¹ã«ç›´æ¥DIã•ã‚Œã‚‹å ´åˆã«ã®ã¿é©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ä»Šã¾ã§å‹•ã„ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ãŒæ„å›³ã›ãšå‹•ä½œã—ãªããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚ã®å›³è§£

ä»¥ä¸‹ãŒã“ã®è¨˜äº‹ã§æ‰±ã†ä¾å­˜é–¢ä¿‚ã®å›³ã§ã™ï¼š

```
v10ã®å‹•ä½œ:
CreditController â”€â”€ä¾å­˜â†’ MoneyService â”€â”€ä¾å­˜â†’ PaymentInterface
     â”‚                                        â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€when().needs()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     ï¼ˆCreditControllerã‹ã‚‰ã®æŒ‡å®šãŒPaymentInterfaceã«å±Šãï¼‰

v11ã®å‹•ä½œ:
CreditController â”€â”€ä¾å­˜â†’ MoneyService â”€â”€ä¾å­˜â†’ PaymentInterface
     â”‚                       â”‚                â†‘
     â””â”€when().needs()â”€â•³      â””â”€when().needs()â”€â”˜
     ï¼ˆç›´æ¥ã®ä¾å­˜å…ˆã«ã®ã¿é©ç”¨ã•ã‚Œã‚‹ï¼‰
```

ã§ã¯ã€å…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã®ã‹ã€ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ä½¿ã£ã¦è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

---

## v10ã®ã‚³ãƒ¼ãƒ‰ä¾‹

ã¾ãšã¯ã€Lumen v10ã§æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ã®ä¾‹ã‹ã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚

### AppServiceProviderå†…ã®è¨­å®š

```php
$this->app->bind(PaymentInterface::class, function ($app) {
    return new class implements PaymentInterface {
        public function paymentMethod(): string
        {
            return 'default';
        }
    };
});

$this->app
    ->when(CreditController::class)
    ->needs(PaymentInterface::class)
    ->give(function () {
        return new class implements PaymentInterface {
            public function paymentMethod(): string
            {
                return 'credit card';
            }
        };
    });
```

ã“ã“ã§ã¯ã€`CreditController` ã‚’åŸºæº–ã« `PaymentInterface` ã®å…·è±¡ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚ˆã†è¨­å®šã—ã¦ã„ã¾ã™ã€‚

### CreditController

```php
class CreditController extends Controller
{
    public function __construct(private MoneyService $moneyService)
    {
    }

    public function index(): string
    {
        return $this->moneyService->paymentMethod();
    }
}
```

`CreditController` ã¯ `MoneyService` ã‚’DIã—ã€ãã®ä¸­ã§ `PaymentInterface` ã® `paymentMethod` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

### MoneyService

```php
class MoneyService
{
    public function __construct(private PaymentInterface $paymentInterface)
    {
    }

    public function paymentMethod(): string
    {
        return $this->paymentInterface->paymentMethod();
    }
}
```

`MoneyService` ã¯ `PaymentInterface` ã‚’DIã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

### å®Ÿè¡Œçµæœ

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’Lumen v10ã§å®Ÿè¡Œã™ã‚‹ã¨ã€`CreditController` ã® `index` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸéš›ã« `'credit card'` ãŒæ­£ã—ãè¿”ã•ã‚Œã¾ã™ã€‚

---

## v11ã®å•é¡Œä¾‹

ã§ã¯ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾Lumen v11ã§å®Ÿè¡Œã™ã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### å•é¡Œã®åŸå› 

`CreditController` ã¯ `MoneyService` ã‚’DIã—ã€ã•ã‚‰ã« `MoneyService` ã¯ `PaymentInterface` ã‚’DIã—ã¦ã„ã¾ã™ã€‚  
ã—ã‹ã—ã€v11ã§ã¯ `when` ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸã‚¯ãƒ©ã‚¹ã«ç›´æ¥DIã•ã‚Œã‚‹å ´åˆã«ã—ã‹é©ç”¨ã•ã‚Œãªããªã‚Šã¾ã—ãŸã€‚ãã®ãŸã‚ã€`CreditController` ã‚’åŸºæº–ã«è¨­å®šã—ã¦ã‚‚ã€ãã®ä¸­ã§ä½¿ç”¨ã•ã‚Œã‚‹ `MoneyService` ã«æ¸¡ã•ã‚Œã‚‹ `PaymentInterface` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã€`default` ãŒè¿”ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

### å®Ÿè¡Œçµæœ

`CreditController` ã‚’å‘¼ã³å‡ºã—ã¦ã‚‚ã€æœŸå¾…ã—ã¦ã„ãŸ `'credit card'` ã§ã¯ãªãã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã® `'default'` ãŒè¿”ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

### ç™ºç”Ÿã™ã‚‹ã‚¨ãƒ©ãƒ¼ã®ä¾‹

æ˜ç¤ºçš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ãŒã€æˆ»ã‚Šå€¤ãŒæœŸå¾…ã¨ç•°ãªã‚‹çµæœã«ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ï¼š

```php
// ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
public function testCreditControllerReturnsCorrectPaymentMethod()
{
    $response = $this->get('/credit');
    $this->assertEquals('credit card', $response->getContent());
    // v11ã§å¤±æ•—ã™ã‚‹ - 'default'ãŒè¿”ã•ã‚Œã‚‹
}
```

å®Ÿéš›ã®é–‹ç™ºç’°å¢ƒã§ã¯ã€ã“ã®ã‚ˆã†ãªæŒ™å‹•ã®é•ã„ãŒåŸå› ã§æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã—ãªããªã‚Šã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

---

## ä¿®æ­£ç‰ˆã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆv11å¯¾å¿œï¼‰

ã§ã¯ã€Lumen v11ã§æ­£ã—ãå‹•ä½œã•ã›ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ  
ç­”ãˆã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€`when` ãƒ¡ã‚½ãƒƒãƒ‰ã§è¨­å®šã™ã‚‹åŸºæº–ã‚’ `MoneyService` ã«å¤‰æ›´ã™ã‚‹ã ã‘ã§ã™ã€‚

### AppServiceProviderå†…ã®è¨­å®š

```php
$this->app->bind(PaymentInterface::class, function ($app) {
    return new class implements PaymentInterface {
        public function paymentMethod(): string
        {
            return 'default';
        }
    };
});

$this->app
    ->when(CreditController::class) 
    ->needs(MoneyService::class)
    ->give(function () {
        $creditCardInterface = new class implements PaymentInterface {
            public function paymentMethod(): string
            {
                return 'credit card';
            }
        };
        return new MoneyService($creditCardInterface);
    });
```

:::message
**ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ**

`needs(PaymentInterface::class)` â†’ `needs(MoneyService::class)`

DIãƒã‚§ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ã¦ã€å®Ÿéš›ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å¿…è¦ã¨ã™ã‚‹ç›´æ¥ã®ä¾å­˜å…ˆã‚¯ãƒ©ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚
:::

ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ã€`needs` ãƒ¡ã‚½ãƒƒãƒ‰ã®åŸºæº–ã‚’ `PaymentInterface` ã§ã¯ãªã `MoneyService` ã«å¤‰æ›´ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚  
ã“ã‚Œã«ã‚ˆã‚Šã€æ­£ã—ã„ `PaymentInterface`ã‚’DIã—ãŸ `MoneyService` ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### CreditController

```php
class CreditController extends Controller
{
    public function __construct(private MoneyService $moneyService)
    {
    }

    public function index(): string
    {
        return $this->moneyService->paymentMethod();
    }
}
```

### MoneyService

```php
class MoneyService
{
    public function __construct(private PaymentInterface $paymentInterface)
    {
    }

    public function paymentMethod(): string
    {
        return $this->paymentInterface->paymentMethod();
    }
}
```

### å®Ÿè¡Œçµæœ

ã“ã®ä¿®æ­£ç‰ˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`CreditController` ã® `index` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸéš›ã« `'credit card'` ãŒæ­£ã—ãè¿”ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## ã¾ã¨ã‚

ä»Šå›ã®å¤‰æ›´ç‚¹ã‚’æŒ¯ã‚Šè¿”ã‚‹ã¨ã€Lumen v11ã§ã¯Contextual Bindingã®ã‚¹ã‚³ãƒ¼ãƒ—ãŒã‚ˆã‚Šå³å¯†ã«ãªã£ãŸã‚ˆã†ã§ã™ã€‚
ãã®çµæœã€`when` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ã¯ã€DIãƒã‚§ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ã¦åŸºæº–ã¨ãªã‚‹ã‚¯ãƒ©ã‚¹ã‚’æ­£ã—ãæŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ä»•æ§˜å¤‰æ›´ã«ã¤ã„ã¦ã¯ã€v10->v11ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚¬ã‚¤ãƒ‰ã«ã‚‚è¨˜è¿°ãŒãªã‹ã£ãŸã‚ˆã†ãªæ°—ãŒã™ã‚‹ã‚“ã§ã™ãŒã€ã€Œã©ã“ã‹ã«æ›¸ã„ã¦ãŸã‚ˆï¼ã€ã¨ã‹ã€Œã“ã†ã™ã‚Œã°v10ã®ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾å‹•ãã‚ˆï¼ã€ãªã©ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«ã¦æ•™ãˆã¦ãã ã•ã„ğŸ™‡

---

## å‚è€ƒè³‡æ–™

- [Laravel v10 Contextual Binding Documentation](https://laravel.com/docs/10.x/container#contextual-binding)
- [Laravel v11 Contextual Binding Documentation](https://laravel.com/docs/11.x/container#contextual-binding)