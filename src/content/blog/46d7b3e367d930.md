---
title: "[Framer motion] アニメーション動作後にposition: fixedが効かない時の対処法"
emoji: "🤕"
type: "tech"
topics:
  - "framer"
  - "react"
  - "framermotion"
published: true
published_at: "2024-01-14 02:18"
updated_at: "2024-01-14 02:18"
---

## バージョン

```
react: 18.2.0
framer-motion: 10.18.0
```

## 問題発生までの道のり

[Framer motion](https://www.framer.com/motion/)を使って、アニメーションありのヘッダーを作成していました。
スクロール量やスクロールの向きに応じて、表示・非表示が切り替わるようにしています。

参考Youtube
https://www.youtube.com/watch?v=qc2kQcicNNc

::::details Header実装例
```js: Header.tsx
'use client';
import {motion, useMotionValueEvent, useScroll} from 'framer-motion'
import Navbar from '@/ui/Navbar';

export default funciton Header(){
  const {scrollY} = useScroll();
  const [hidden, setHidden] = useState(false);
  
  useMotionValueEvent(scrollY, 'change', (latest) => {
    const previous = scrollY.getPrevious();
    if(latest > previous && latest > 120){
      setHidden(true);
    }else{
      setHidden(false);
    }
  });
  
 return (
   <motion.header
     className="fixed right-0 top-0 z-20 bg-white"
     variants={{
       visible: {
         y:0,
       },
       hidden: {y: '-100%'}
     }}
     animate={hidden ? 'hidden' : 'visible'}
     transition={{duration: 0.35, ease: 'easeInOut'}}
   >
    <Link href={'/'}>
      <Image src="/img/icon.svg">
    </Link>
    <Navbar />
   </motion.header>
 );
};
```
::::

---

ヘッダーがSPサイズの場合はハンバーガーメニューを表示させていました。
ハンバーガーメニューをクリックすると`position:fixed`が指定されたナビゲーションメニューが画面全体に表示される仕様です。

::::details Navbar実装例
参考: https://github.com/shaunchander/building-animated-navbars/blob/master/src/Navbar.jsx
::::  

ページに遷移して、何もスクロールしないでハンバーガーメニューをクリックすると綺麗にナビゲーションメニューが画面いっぱいに表示されます。
いい感じです。

<img src="https://storage.googleapis.com/zenn-user-upload/e9ce54dfc097-20240114.png" width="200" alt="" />

---

しかし、問題はヘッダーのアニメーションを動作させた後に起こりました。
アニメーション起動後に、ハンバーガーメニューをクリックすると何故か画面全体にナビゲーションメニューが表示されません。
その親要素であるヘッダーの要素全体に対して、`position:fixed`が効いてしまうようになりました。

<img src="https://storage.googleapis.com/zenn-user-upload/35f7addc659a-20240114.png" width="200" alt="" />


## 原因

ナビゲーションメニューの親要素であるヘッダーのstyleタグに`transform`が存在していることです。

:::message alert
アニメーションが動作すると、動的にtransformの値が`transform: translateY(0%)`　や `transform: translateZ(0%)`のように変わります。
この状態になると、問題の挙動が発生します。
:::

:::message
`transform:none`の場合は**今回の問題を引き起こしません。**
:::

### 問題無しパターン

`style="transform: none"`
`position: fixed`が**画面全体に対して適用される**

![](https://storage.googleapis.com/zenn-user-upload/755680aebc28-20240114.png)

### 問題発生パターン

`style="transform: translateY(0%) translateZ(0%)"`
`position: fixed`が**親要素全体に対して適用される**

![](https://storage.googleapis.com/zenn-user-upload/219cf4ab3b96-20240114.png)

## 解決策

`transitionEnd`を利用して、transformの値を上書きしてやりましょう。
今回問題になっているのは`motion.header`部分なのでそのvariants内に`transitionEnd`を追加しましょう。

```diff js
 <motion.header
   variants={{
     visible: {
       y:0,
+      transitionEnd: {x:0, y:0} 
     }
   }}
 >
 </motion.header>
```

この記述をすることで、transformの値をアニメーション終了後に`transform: none`に上書きしています。
これで、framer motionのアニメーションが動いた後でも、画面全体に対して`position: fixed`を適用させることができました。

この挙動については、Chrome側のバグらしいのでFramer motionは何も悪くないらしいです。
Chrome側で早めに修正されることを祈ります🙏

## 参考Issue

https://github.com/framer/motion/issues/823#issuecomment-1276670313